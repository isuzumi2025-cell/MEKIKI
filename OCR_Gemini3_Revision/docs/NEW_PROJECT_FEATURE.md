# ➕ 新規プロジェクト作成機能

## 概要

URLとPDFを指定して、Webクロール・PDF読込・OCR・マッチングを一括実行する機能です。

---

## 📁 実装ファイル

```
app/gui/dialogs/
└── project_dialog.py      # 新規プロジェクトダイアログ ✨

app/gui/
├── navigation.py          # 「➕ 新規プロジェクト」ボタン追加
└── main_window_v2.py      # 分析プロセス統合
```

---

## 🎨 UI構成

### プロジェクトダイアログ

```
┌─────────────────────────────────────────────┐
│ ➕ 新規プロジェクト作成                      │
│   URLとPDFを指定して分析を開始します         │
├─────────────────────────────────────────────┤
│                                             │
│  🌐 Web設定                                 │
│  ┌─────────────────────────────────────┐   │
│  │ 対象URL: https://example.com        │   │
│  └─────────────────────────────────────┘   │
│  クロール深さ: [=========●==] 2階層        │
│  最大ページ数: [10] ページ                  │
│                                             │
│  ────────────────────────────────────────   │
│                                             │
│  📁 PDF設定                                 │
│  PDFファイル: [ファイルが選択されていません]│
│                                      [選択] │
│  PDFフォルダ: [フォルダが選択されていません]│
│                                      [選択] │
│                                             │
│  ────────────────────────────────────────   │
│                                             │
│  ⚙️ 詳細設定                                │
│  [✓] Google Cloud Vision API を使用する    │
│  類似度閾値: [=========●==] 30%            │
│                                             │
├─────────────────────────────────────────────┤
│  [✖ キャンセル]              [🚀 分析開始] │
└─────────────────────────────────────────────┘
```

---

## 🚀 使用方法

### 1. ダイアログを開く

ナビゲーションパネルの「➕ 新規プロジェクト」ボタンをクリック。

### 2. 設定を入力

#### Web設定
- **対象URL**: クロールを開始するURL
- **クロール深さ**: 1〜5階層（デフォルト: 2）
- **最大ページ数**: 取得するページ数の上限（デフォルト: 10）

#### PDF設定
- **PDFファイル**: 単一のPDFファイルを選択
- **PDFフォルダ**: フォルダ内の全PDFを読み込み
  - ※どちらか一方を選択

#### 詳細設定
- **Google Cloud Vision API**: OCRを有効化（credentials.json必要）
- **類似度閾値**: マッチング判定の閾値（10〜90%）

### 3. 分析開始

「🚀 分析開始」ボタンをクリックすると、以下の処理が自動実行されます：

```
1. 🌐 Webページをクロール中...
   ↓
2. 📁 PDFを読み込み中...
   ↓
3. 🔍 OCR実行中... (オプション)
   ↓
4. ⚡ マッチング実行中...
   ↓
5. ✅ 完了 → 全体マップ表示
```

---

## 🔧 技術詳細

### データフロー

```python
ProjectDialog
    ↓ (ユーザー入力)
MainWindow.new_project()
    ↓
MainWindow.start_analysis(config)
    ↓ (バックグラウンド処理)
┌─────────────────────────────┐
│ 1. _crawl_web_pages()       │
│    EnhancedScraper使用      │
│                             │
│ 2. _load_pdf_pages()        │
│    PDFLoader使用            │
│                             │
│ 3. OCR実行 (オプション)     │
│    OCREngine使用            │
│                             │
│ 4. Analyzer.compute_auto_   │
│    matches()                │
└─────────────────────────────┘
    ↓
MacroView.load_from_analyzer()
    ↓
全体マップ表示
```

### コード例

#### ダイアログの使用

```python
from app.gui.dialogs.project_dialog import ProjectDialog

# ダイアログを開く
dialog = ProjectDialog(
    parent_window,
    on_start=callback_function
)

# 待機
parent_window.wait_window(dialog)

# 結果を取得
result = dialog.get_result()
# {
#     "url": "https://example.com",
#     "depth": 2,
#     "max_pages": 10,
#     "pdf_file": "path/to/file.pdf",
#     "pdf_folder": None,
#     "use_ocr": True,
#     "threshold": 0.3
# }
```

#### 分析プロセスの実装

```python
def start_analysis(self, config: Dict):
    """分析を開始"""
    # ローディング画面表示
    self._show_loading_screen()
    
    # バックグラウンド処理
    def _run_analysis():
        try:
            # Webクロール
            web_results = self._crawl_web_pages(...)
            
            # PDF読込
            pdf_results = self._load_pdf_pages(...)
            
            # マッチング
            pairs = self.analyzer.compute_auto_matches(...)
            
            # 完了
            self.after(0, lambda: self._on_analysis_complete(...))
            
        except Exception as e:
            self.after(0, lambda: self._on_analysis_error(e))
    
    threading.Thread(target=_run_analysis, daemon=True).start()
```

---

## 📊 設定パラメータ

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| `url` | str | - | クロール対象URL |
| `depth` | int | 2 | クロール深さ（1-5） |
| `max_pages` | int | 10 | 最大ページ数 |
| `pdf_file` | str | None | PDFファイルパス |
| `pdf_folder` | str | None | PDFフォルダパス |
| `use_ocr` | bool | True | OCR使用有無 |
| `threshold` | float | 0.3 | 類似度閾値（0.1-0.9） |

---

## 🎯 ローディング画面

分析中は以下のローディング画面が表示されます：

```
┌─────────────────────────────────────┐
│                                     │
│          🔄 処理中...               │
│                                     │
│     🌐 Webページをクロール中...     │
│                                     │
│    ▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░          │
│                                     │
└─────────────────────────────────────┘
```

メッセージは処理の進行に応じて更新されます：
1. 🌐 Webページをクロール中...
2. 📁 PDFを読み込み中...
3. 🔍 OCR実行中...
4. ⚡ マッチング実行中...

---

## ✅ 完了メッセージ

分析完了時に表示されるメッセージボックス：

```
┌─────────────────────────────┐
│  ✅ 分析が完了しました       │
│                             │
│  Web: 5 ページ              │
│  PDF: 3 ページ              │
│  マッチング: 4 ペア         │
│                             │
│         [ OK ]              │
└─────────────────────────────┘
```

完了後、自動的に全体マップ（MacroView）に遷移します。

---

## 🐛 エラーハンドリング

### 入力検証

- URLが空 → 「URLを入力してください」
- URL形式が不正 → 「有効なURLを入力してください」
- PDF未選択 → 「PDFファイルまたはフォルダを選択してください」

### 処理エラー

- クロールエラー → ログに出力、空の結果を返す
- PDF読込エラー → ログに出力、空の結果を返す
- マッチングエラー → エラーダイアログ表示、ウェルカム画面に戻る

---

## 🔜 今後の拡張

### 実装予定
- [ ] PDFフォルダの再帰的読み込み
- [ ] クロール進捗のリアルタイム表示
- [ ] クロール結果のプレビュー
- [ ] 設定のプリセット保存

### 改善案
- [ ] クロールのキャンセル機能
- [ ] 詳細なログ表示
- [ ] エラーリカバリー機能

---

## 📝 使用例

### 基本的なワークフロー

```python
# 1. アプリ起動
from app.gui.main_window_v2 import MainWindow
app = MainWindow()

# 2. 「➕ 新規プロジェクト」クリック
# → ProjectDialogが開く

# 3. 設定を入力
# URL: https://example.com
# PDF: document.pdf
# OCR: 有効

# 4. 「🚀 分析開始」クリック
# → バックグラウンドで処理開始

# 5. 完了後、全体マップ表示
# → MacroViewでマッチング結果を確認
```

---

## 🎨 UI設計のポイント

### 1. 目立つ配色
- ボタン: オレンジ（`#FF6F00`）
- ヘッダー: 緑（`#4CAF50`）

### 2. 明確なフロー
- Web設定 → PDF設定 → 詳細設定 → 実行

### 3. リアルタイムフィードバック
- スライダーの値をリアルタイム表示
- ファイル選択後に即座にパス表示

### 4. エラー防止
- 入力検証でエラーを事前に防止
- わかりやすいエラーメッセージ

---

**🎉 新規プロジェクト作成機能の実装完了！**

直感的なUIで、複雑な分析プロセスを簡単に実行できるようになりました。

