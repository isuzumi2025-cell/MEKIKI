# ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## ğŸ“ å…¨ä½“æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Main Application                     â”‚
â”‚                     (main.py)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                         â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   Core Engines  â”‚        â”‚   GUI Modules   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â”‚           â”‚          â”‚              â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Crawler â”‚ â”‚Cluster-â”‚ â”‚Compar-â”‚  â”‚Canvas Editor  â”‚
â”‚        â”‚ â”‚ing     â”‚ â”‚ator   â”‚  â”‚& Macro View   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ

### 1. ã‚³ã‚¢ã‚¨ãƒ³ã‚¸ãƒ³ (`app/core/`)

#### `engine_clustering.py` - ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³
**è²¬å‹™**: ç”»åƒè§£æçµæœã‹ã‚‰æ„å‘³ã®ã‚ã‚‹é ˜åŸŸã‚’è‡ªå‹•æ¤œå‡º

**ä¸»è¦ã‚¯ãƒ©ã‚¹**:
- `ClusteringEngine`: ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
- `BlockExtractor`: Vision API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‘ãƒ¼ã‚µãƒ¼

**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **:
```python
def cluster_from_blocks(blocks):
    # Phase 1: è¿‘æ¥ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°
    vertical_clusters = _vertical_stack_clustering(blocks)
    
    # Phase 2: å­¤ç«‹ã‚¨ãƒªã‚¢ã®å¸å
    final_clusters = _orphan_absorption(vertical_clusters)
    
    return sorted_clusters
```

**å…¥åŠ›**:
```python
blocks = [
    {
        "text": "ãƒ†ã‚­ã‚¹ãƒˆ",
        "rect": [x0, y0, x1, y1],
        "center_x": float,
        "width": float,
        "font_size": float
    }
]
```

**å‡ºåŠ›**:
```python
clusters = [
    {
        "id": 1,
        "rect": [x0, y0, x1, y1],
        "text": "çµ±åˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ"
    }
]
```

#### `crawler.py` - Webã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼
**è²¬å‹™**: Webãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±

**ä¸»è¦ã‚¯ãƒ©ã‚¹**:
- `WebCrawler`: ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°å®Ÿè¡Œ
- `URLManager`: URLç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

**ãƒ•ãƒ­ãƒ¼**:
```
URLå…¥åŠ› â†’ Playwrightèµ·å‹• â†’ ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ â†’ 
å¾…æ©Ÿ(networkidle + sleep) â†’ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ â†’ 
Cookieä¿å­˜
```

#### `pdf_loader.py` - PDFãƒ­ãƒ¼ãƒ€ãƒ¼
**è²¬å‹™**: PDFã‚’é«˜è§£åƒåº¦ç”»åƒã«å¤‰æ›

**ä¸»è¦ã‚¯ãƒ©ã‚¹**:
- `PDFLoader`: PDFâ†’ç”»åƒå¤‰æ›
- `ImageOptimizer`: OCRæœ€é©åŒ–

**å¤‰æ›ãƒ—ãƒ­ã‚»ã‚¹**:
```
PDF â†’ PyMuPDF â†’ ãƒ”ã‚¯ã‚¹ãƒãƒƒãƒ—(zoomå€ç‡) â†’ 
PIL Image â†’ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)æœ€é©åŒ– â†’ å‡ºåŠ›
```

#### `comparator.py` - æ¯”è¼ƒã‚¨ãƒ³ã‚¸ãƒ³
**è²¬å‹™**: Web vs PDF ã®å·®åˆ†æ¤œå‡º

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
- `compare_all()`: å…¨ã‚¨ãƒªã‚¢æ¯”è¼ƒ
- `_calculate_similarity()`: ãƒ†ã‚­ã‚¹ãƒˆé¡ä¼¼åº¦è¨ˆç®—
- `get_summary()`: ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
- `export_to_csv/html()`: ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›

**é¡ä¼¼åº¦è¨ˆç®—**:
```python
# SequenceMatcherã‚’ä½¿ç”¨
similarity = difflib.SequenceMatcher(
    None, text1, text2
).ratio()  # 0.0 - 1.0
```

#### `engine_spreadsheet.py` - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸ
**è²¬å‹™**: Google Sheets ã¨ã®åŒæ–¹å‘åŒæœŸ

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
- `sync_clusters()`: ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±ã‚’æ›¸ãè¾¼ã¿
- `update_cluster()`: ç‰¹å®šã‚¨ãƒªã‚¢ã‚’æ›´æ–°
- `read_clusters_from_sheet()`: ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿

**ã‚¹ã‚­ãƒ¼ãƒ**:
```
| Area ID | Position | Extracted Text | Human Verify | Correction | Status | Timestamp |
```

### 2. GUI ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (`app/gui/`)

#### `canvas_editor.py` - Canvasç·¨é›†UI
**è²¬å‹™**: ç”»åƒã¨ã‚¯ãƒ©ã‚¹ã‚¿ã®ç·¨é›†å¯èƒ½UI

**ä¸»è¦æ©Ÿèƒ½**:
- ç”»åƒè¡¨ç¤ºï¼ˆè‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰
- ã‚¯ãƒ©ã‚¹ã‚¿æ ã®æç”»
- ãƒ‰ãƒ©ãƒƒã‚°ã§æ–°è¦ã‚¨ãƒªã‚¢ä½œæˆ
- ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
- å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤

**ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
```python
ButtonPress-1  â†’ ã‚¯ãƒ©ã‚¹ã‚¿é¸æŠ or æ–°è¦ä½œæˆé–‹å§‹
B1-Motion      â†’ ãƒ‰ãƒ©ãƒƒã‚°ä¸­ï¼ˆä»®çŸ©å½¢æ›´æ–°ï¼‰
ButtonRelease-1 â†’ æ–°è¦ã‚¨ãƒªã‚¢ç¢ºå®š
Button-3       â†’ å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
```

#### `macro_view.py` - ãƒã‚¯ãƒ­ãƒ“ãƒ¥ãƒ¼
**è²¬å‹™**: Web vs PDF ã®å…¨ä½“æ¯”è¼ƒãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³

**è¡¨ç¤ºãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Toolbar (ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚ºãƒ¼ãƒ )  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Webç”»åƒ    â”‚    PDFç”»åƒ       â”‚
â”‚ (ã‚¢ãƒãƒ†ãƒ¼ãƒˆæ¸ˆ)â”‚  (ã‚¢ãƒãƒ†ãƒ¼ãƒˆæ¸ˆ)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è‰²åˆ†ã‘ãƒ«ãƒ¼ãƒ«**:
- ğŸŸ¢ ç·‘: ä¸€è‡´ (match)
- ğŸ”´ èµ¤: ä¸ä¸€è‡´ (mismatch)
- ğŸ”µ é’: Webå°‚ç”¨ (web_only)
- ğŸŸ  ã‚ªãƒ¬ãƒ³ã‚¸: PDFå°‚ç”¨ (pdf_only)

### 3. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (`app/utils/`)

#### `helpers.py`
- `save_clusters_to_json()`: JSONä¿å­˜
- `load_clusters_from_json()`: JSONèª­ã¿è¾¼ã¿
- `create_output_directory()`: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ããƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
- `sanitize_filename()`: ãƒ•ã‚¡ã‚¤ãƒ«åã‚µãƒ‹ã‚¿ã‚¤ã‚º

#### `logger.py`
- `setup_logger()`: ãƒ­ã‚¬ãƒ¼åˆæœŸåŒ–
- ã‚³ãƒ³ã‚½ãƒ¼ãƒ« + ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### å…¸å‹çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

```
1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Web URL â”‚      â”‚   PDF   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                â”‚
        â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Crawler  â”‚      â”‚PDFLoaderâ”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                â”‚
        â–¼                â–¼
   [Web Image]      [PDF Image]

2. AIè§£æï¼ˆã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ï¼‰
   [Image] â†’ Vision API â†’ Blocks â†’ ClusteringEngine â†’ Clusters

3. ç·¨é›†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   Clusters â†’ CanvasEditor â†’ æ‰‹å‹•ç·¨é›† â†’ Updated Clusters

4. æ¯”è¼ƒ
   [Web Clusters] + [PDF Clusters] â†’ Comparator â†’ Results

5. å‡ºåŠ›
   Results â†’ SpreadsheetEngine â†’ Google Sheets
          â†’ CSV/HTML â†’ ãƒ•ã‚¡ã‚¤ãƒ«
```

## ğŸ§  ã‚³ã‚¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è©³ç´°

### è¿‘æ¥ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°

**ç›®çš„**: ç¸¦æ–¹å‘ã«è¿‘ã„æ–‡å­—ãƒ–ãƒ­ãƒƒã‚¯ã‚’çµ±åˆ

**æ¡ä»¶**:
1. æ¨ªæ–¹å‘ã®ä½ç½®åˆã‚ã›
   ```python
   overlap_ratio > 0.7 or left_diff < 20px
   ```

2. ç¸¦æ–¹å‘ã®é–“éš”
   ```python
   gap_y < max(font_size * 2.5, 80px)
   ```

3. ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã®æ•´åˆæ€§
   ```python
   smaller_font * 2.0 > larger_font > smaller_font * 0.5
   ```

4. æ¨ªä¸¦ã³é˜²æ­¢
   ```python
   horizontal_gap < 10px
   ```

**æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰**:
```
while çµåˆå¯èƒ½ãªãƒšã‚¢ãŒå­˜åœ¨:
    for each cluster C:
        for each cluster T (C ã‚ˆã‚Šä¸‹):
            if æ¡ä»¶1 and æ¡ä»¶2 and æ¡ä»¶3 and æ¡ä»¶4:
                C ã¨ T ã‚’çµåˆ
                T ã‚’å‰Šé™¤ãƒªã‚¹ãƒˆã«è¿½åŠ 
```

### å‹•çš„å¯†åº¦ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°

**ç›®çš„**: å­¤ç«‹ã—ãŸå°é ˜åŸŸã‚’è¦ªé ˜åŸŸã«å¸å

**å­¤ç«‹åˆ¤å®š**:
```python
is_orphan = (
    area < average_area * 0.1 or
    text_length < 3
)
```

**å¸åå‡¦ç†**:
```python
for orphan in orphans:
    parent = find_nearest_parent(orphan, distance < 200px)
    if parent:
        parent.merge(orphan)
    else:
        keep_as_independent(orphan)
```

## ğŸ”Œ æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

### 1. ã‚«ã‚¹ã‚¿ãƒ OCRã‚¨ãƒ³ã‚¸ãƒ³ã®è¿½åŠ 

```python
# app/core/engine_custom.py
class CustomOCREngine:
    def extract_text(self, image):
        # ç‹¬è‡ªã®OCRãƒ­ã‚¸ãƒƒã‚¯
        return blocks, raw_words
```

### 2. æ–°ã—ã„æ¯”è¼ƒãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¿½åŠ 

```python
# app/core/comparator.py
def _calculate_custom_similarity(self, text1, text2):
    # ç‹¬è‡ªã®é¡ä¼¼åº¦è¨ˆç®—
    # ä¾‹: ç·¨é›†è·é›¢ã€BERTåŸ‹ã‚è¾¼ã¿ã€etc.
    return similarity_score
```

### 3. å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®è¿½åŠ 

```python
# app/core/comparator.py
def export_to_json(self, output_path):
    # JSONå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    pass
```

### 4. UIã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

```python
# app/gui/custom_view.py
class CustomView:
    # ç‹¬è‡ªã®ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    pass
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°
- **æ™‚é–“è¨ˆç®—é‡**: O(nÂ²) â†’ åå¾©çµ±åˆ
- **æœ€é©åŒ–æ¡ˆ**: KD-Tree ã§è¿‘å‚æ¤œç´¢ã‚’é«˜é€ŸåŒ–

### ç”»åƒå‡¦ç†
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: ç”»åƒã‚µã‚¤ã‚ºã«ä¾å­˜
- **æœ€é©åŒ–æ¡ˆ**: 
  - ã‚¿ã‚¤ãƒ«åˆ†å‰²å‡¦ç†
  - æ®µéšçš„è§£åƒåº¦ã‚¢ãƒƒãƒ—

### GUIæç”»
- **ãƒœãƒˆãƒ«ãƒãƒƒã‚¯**: Canvas ã®å†æç”»
- **æœ€é©åŒ–æ¡ˆ**:
  - å·®åˆ†æ›´æ–°
  - ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

1. **èªè¨¼æƒ…å ±ã®ç®¡ç†**
   - `service_account.json` ã‚’ `.gitignore` ã«è¿½åŠ 
   - ç’°å¢ƒå¤‰æ•°ã§ã®ç®¡ç†ã‚‚æ¤œè¨

2. **å…¥åŠ›æ¤œè¨¼**
   - URL ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

3. **æ¨©é™ç®¡ç†**
   - ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æœ€å°æ¨©é™
   - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå…±æœ‰ã®åˆ¶å¾¡

## ğŸ“š å‚è€ƒè³‡æ–™

- [Google Cloud Vision API](https://cloud.google.com/vision/docs)
- [Playwright Documentation](https://playwright.dev/python/)
- [PyMuPDF Documentation](https://pymupdf.readthedocs.io/)
- [CustomTkinter Documentation](https://customtkinter.tomschimansky.com/)

