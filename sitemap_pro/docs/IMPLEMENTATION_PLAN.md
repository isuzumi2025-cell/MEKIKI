# 統合テキスト抽出・比較システム実装計画

## 概要
sitemap_appのVisualizerを拡張し、WebとPDFからテキストを抽出・比較・校正できるマルチウィンドウシステムを構築する。

## 統合対象コンポーネント

| ソース | コンポーネント | 機能 |
|--------|--------------|------|
| `Scraper/` | `DomXPathHandler` | DOM/XPath テキスト抽出 |
| `Scraper/` | `PlaywrightCapture` | 高品質スクリーンショット |
| `OCR/` | `EnhancedWebScraper` | Ultrathink スティッチング |
| `OCR/` | `ocr_engine.py` | Google Vision OCR + パラグラフ検出 |
| `OCR/` | `interactive_canvas.py` | 範囲選択 + オニオンスキン |

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                    統合ビューワー (Browser)                      │
├───────────────────────┬───────────────────────┬─────────────────┤
│    📄 Web Panel       │    📄 PDF Panel        │  📝 比較パネル   │
│  ┌─────────────────┐  │  ┌─────────────────┐  │  ┌───────────┐  │
│  │ スクリーンショット │  │  │ PDF レンダリング  │  │  │ 差分表示  │  │
│  │ + 選択領域       │  │  │ + 選択領域       │  │  │ Sync Rate │  │
│  └─────────────────┘  │  └─────────────────┘  │  └───────────┘  │
│  ┌─────────────────┐  │  ┌─────────────────┐  │  ┌───────────┐  │
│  │ 抽出テキスト     │  │  │ OCR テキスト     │  │  │ 校正結果  │  │
│  │ (リアルタイム)    │  │  │ (リアルタイム)    │  │  └───────────┘  │
│  └─────────────────┘  │  └─────────────────┘  │                 │
└───────────────────────┴───────────────────────┴─────────────────┘
                              ▲
                    ┌─────────┴─────────┐
                    │   Python Backend   │
                    │  (FastAPI Server)  │
                    └─────────┬─────────┘
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │ Scraper     │    │ OCR Engine  │    │ Text Diff   │
   │ (DOM/Text)  │    │ (Vision API)│    │ (Python)    │
   └─────────────┘    └─────────────┘    └─────────────┘
```

---

## 実装フェーズ

### Phase 1: コアモジュール統合
`app/core/text_extractor.py` を新規作成

**機能:**
- [x] DOM ベーステキスト抽出 (DomXPathHandler 統合)
- [x] OCR テキスト抽出 (ocr_engine 統合)
- [x] PDF テキスト抽出 (PyMuPDF)
- [x] パラグラフ自動検出

#### [NEW] [text_extractor.py](file:///c:/Users/raiko/OneDrive/Desktop/26/sitemap_app/app/core/text_extractor.py)

---

### Phase 2: API エンドポイント追加
`app/api/endpoints.py` に追加

**新規エンドポイント:**
- `POST /extract/web` - Web URL からテキスト抽出
- `POST /extract/pdf` - PDF からテキスト抽出 (OCR)
- `POST /extract/region` - 指定領域のテキスト抽出
- `POST /compare` - 2テキスト比較・差分計算
- `GET /jobs/{id}/extracted-texts` - 抽出済みテキスト取得

#### [MODIFY] [endpoints.py](file:///c:/Users/raiko/OneDrive/Desktop/26/sitemap_app/app/api/endpoints.py)

---

### Phase 3: マルチウィンドウUI実装
`exporter.py` の HTML を大幅拡張

**機能:**
- 2x3 マトリクスレイアウト (6パネル)
- 領域選択キャンバス (Canvas API)
- リアルタイムテキストプレビュー
- 差分ハイライト表示
- 同期スクロール

#### [MODIFY] [exporter.py](file:///c:/Users/raiko/OneDrive/Desktop/26/sitemap_app/app/core/exporter.py)

---

### Phase 4: 領域選択機能 (Interactive Canvas)
JavaScript版 InteractiveCanvas を実装

**機能:**
- マウスドラッグで矩形選択
- パラグラフ自動検出・スナップ
- 選択領域の編集・削除
- リアルタイムテキスト反映

---

### Phase 5: テキスト比較エンジン
`app/core/text_comparator.py` を新規作成

**機能:**
- 文字単位差分 (diff-match-patch)
- Sync Rate 計算
- 校正候補提案
- LLM 連携 (オプション)

#### [NEW] [text_comparator.py](file:///c:/Users/raiko/OneDrive/Desktop/26/sitemap_app/app/core/text_comparator.py)

---

## 依存関係

```txt
# 追加が必要なパッケージ
PyMuPDF>=1.23.0        # PDF操作
google-cloud-vision    # OCR (既存)
diff-match-patch       # テキスト差分
python-multipart       # ファイルアップロード
```

---

## UI レイアウト詳細

### マトリクスモード: 2x3 グリッド

```
┌────────────────────────────────────────────────────────────┐
│ ツールバー: [ソース選択] [比較実行] [レイアウト切替] [保存]    │
├─────────────────────┬─────────────────────┬────────────────┤
│  🌐 Web キャプチャ   │  📕 PDF プレビュー   │  📊 比較結果    │
│  ┌───────────────┐  │  ┌───────────────┐  │  Sync: 95.2%  │
│  │               │  │  │               │  │  差異: 3箇所   │
│  │ [選択領域表示] │  │  │ [選択領域表示] │  │               │
│  │               │  │  │               │  │ ┌───────────┐ │
│  └───────────────┘  │  └───────────────┘  │ │ 差分一覧   │ │
├─────────────────────┼─────────────────────┤ └───────────────┤
│  📝 Web 抽出テキスト  │  📝 PDF 抽出テキスト  │  ✏️ 校正提案    │
│  ┌───────────────┐  │  ┌───────────────┐  │  ┌───────────┐ │
│  │ リアルタイム   │  │  │ リアルタイム   │  │  │ 修正案1   │ │
│  │ テキスト表示   │  │  │ テキスト表示   │  │  │ 修正案2   │ │
│  └───────────────┘  │  └───────────────┘  │  └───────────┘ │
└─────────────────────┴─────────────────────┴────────────────┘
```

---

## 操作フロー

1. **ソース選択**
   - Web: URL入力 or サイトマップからノード選択
   - PDF: ファイルアップロード or URL指定

2. **自動抽出**
   - Web: DOM解析 + スクリーンショット
   - PDF: OCR (パラグラフ自動検出)

3. **手動調整**
   - マウスドラッグで領域選択
   - 既存領域のリサイズ/移動
   - 領域削除

4. **リアルタイム反映**
   - 選択領域変更 → テキストパネル即時更新
   - WebSocket で低遅延通信

5. **比較実行**
   - テキスト差分計算
   - Sync Rate 表示
   - 差異箇所ハイライト

6. **校正・保存**
   - 校正結果をJSON/Excelで出力
   - スクリーンショット付きレポート

---

## User Review Required

> [!IMPORTANT]
> 以下の点について確認をお願いします:
> 1. **Google Cloud Vision API** を使用しますが、既存の認証情報はOCRフォルダにありますか？
> 2. **LLM連携** (校正提案) は必要ですか？Gemini APIを使用できますか？
> 3. **優先順位**: まずはどの機能から実装しますか？
>    - A) テキスト抽出のみ (Web + PDF)
>    - B) 比較機能のみ
>    - C) フル機能 (時間がかかります)

---

## 検証計画

### 自動テスト
- テキスト抽出APIのユニットテスト
- 差分計算の正確性テスト

### 手動検証
- 実際のWebサイトとPDFでの比較テスト
- 領域選択UIの操作感確認
- リアルタイム更新のレスポンス確認
